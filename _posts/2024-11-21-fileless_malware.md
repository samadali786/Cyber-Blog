---

title: "What is FileLess Malware and how it works in Windows OS using C++"
date: "2024-11-22 00:00:00"
categories: [Malware Analysis, FileLess Malware Analysis Project]
tags: [Malware Analysis]

---

# Overview

Fileless Malware is a type of malicious code that is attached or inject to any of the legimate program process to infect a computer. It's hard to detect and often evades detection by most of the security solutions. It is differnt then most of the traditional virus because it operates in memory and not stored in the file. filess infections go straight to the computer memory without touching the drives and as a result it often undected by antivirus, whitelisting, and other endpoint security solutions.


# Processes in Windows OS

If we open the task manager in Windows OS we see many different types of processes each process is belong to the program that are running on the computer. These processes divided into user mode processes (Background process) and System processes (Windows Process) which is the part of the Windows OS and have a highest privilages. there are also other GUI tool like Process Hacker which gives us more GUI feature to do in depth analysis of the process like PID(Process Identifier of each process).


Processes from the Task manager tool in Windows OS 
![Task Manager](../../assets/filelessmalimages/task_manag.png)

 Process from the Process Hacker tool with PID in Windows OS
![alt text](assets\fileless_mal_proj_images\proc_hack_pid.png)

# Use of PID (Process Identifier) in FileLess attack

Each process has it's own uniquie process indentifier number that is associated with it. Threat actor or attacker uses these PID number to perform Fileless attack to get the handle to a process by doing that they can perform allocating memmory, modifying the privillages in certain pages in the memory basically they can manipulate the process however they want


# Basic Layout of the Memory with 32 and 64 bit addresses   

Memory consists of multiple blocks and these blocks are called pages and each page has certain properties like size, range of address, security flags permissions like RWX(read, write, and execute), and "committed" or "reserved".

Memory Layout
![alt text](assets\fileless_mal_proj_images\mem_layout.png)

Memmory Layout types
![alt text](assets\fileless_mal_proj_images\mem_add_type.png)

For 32 bit address all memory addresses have a max size of 4 bytes or a "DWORD(double word)". A word is 2 Byte so DWORD is double byte which is equal to 4 bytes. A "QWORD" as it equal to 8 bytes. For 64 bit everything is same except the size of the addressses is a maximum size of "QWORD" 8 bytes.  

Memory addresses
![alt text](assets\fileless_mal_proj_images\mem_addr.png)

# Shellcode

It is a type of assembly code that works as a payload behind the high level programing language like C++ which is use to executes a shell command, reverse shell, or any pop ups or a message box. the main purpose of using shellcode is to avoid the detection from Anti-viruses and EDR's. most of the antivirus softwares using signature based detections to find any suspicious windows api's in the malicious files and flags the file as malicious, but
if the antivirus software have a huge databse of signatured shellcode the could be detected as a malware, most of the advanced technique that are used by the attackers is to ecncrypt the shellcode with cryptographic algorithm like RC4 to avoid detection, but this is more advance technique. 

Shellcode that is use to open the messagebox in C++
![alt text](assets\fileless_mal_proj_images\shell_code_C++.png)

# The Windows API exploited using Python scripts

Windows API provides a usefull libraries or ".dll" files which gives many functions by using the simple python scripts attacker can use export functions to use the functions that are exported by the "kernel32.dll" library to view all the Windows API's like "CreateRemoteThread", "WriteProcessMemory" and many other api's, 

Windows API library kernel32.dll exploited using Python script
![alt text](assets\fileless_mal_proj_images\windows_api_pyht_scr.png)

Another thing the attackers are using the struct data type from C++ as a predefined struct to store a data that are retun by Windows API
As a Example "Process32First" and "Process32next" are the Windows API's that take in struct called "PROCESSENTRY32" as a secound parameter and if it succed it gives information related to certain process like name and id of the process, there are many different types of struct that are provided by Windows API that could be exploited just by using "include <windows.h> header file in C++ to use all of the Windows API's.


Windows API "Process32First" and "Process32next" that take in "PROCESENTRY32" struct and gives process information

![alt text](assets\fileless_mal_proj_images\Windows_struct_api.png)

# Injections techniques in Fileless Malware

The main purpose of using injection attacks is to inject the malicious code direclty to the memory instead of writting it and execute on the disk to avoid detections as we know that each running process has its own memory so attacker take advantage of this behaviour and instead of running malicious code to the disk they inject the malicious code to the process memory, and then the injected shellcode get executed. There are two types of injection techniques that are use in Fileless Malware process injection and self injections all of the injection attacks have three things in common.

# 1. Allocate Memory for Shellcode

In this step attacker allocate the memory for the malicious code(Shellcode) that they want to executed.

Allocate memory
![alt text](assets\fileless_mal_proj_images\allocate_mem_shell.png)

# 2. Write Shellcode to the allocated Memory

In this step attacker write the malicious code (Shellcode) into allocated memory.

Writing shellcode to the allocated memory
![alt text](assets\fileless_mal_proj_images\write_shellcode.png)

# 3. Executing the Shellcode

In this step the attacker finally execute the shellcode in the memory

Execute shellcode
![alt text](assets\fileless_mal_proj_images\exec_shellcode.png)
